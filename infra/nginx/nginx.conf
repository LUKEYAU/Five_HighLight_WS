user  nginx;
worker_processes auto;

events { worker_connections 1024; }

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  # 更長的 timeout 對上傳/串流友善
  client_max_body_size 0;                 # 不限制請求大小（由 S3/後端控）
  sendfile        on;
  tcp_nopush      on;
  tcp_nodelay     on;
  keepalive_timeout 65;

  # 真實客戶端位址
  real_ip_header X-Forwarded-For;

  # 禁止 mp4/ts/gz 等被壓縮（避免串流卡頓）
  map $sent_http_content_type $disable_gzip {
    default 0;
    ~*video/ 1;
    ~*application/octet-stream 1;
  }
  gzip on;
  gzip_types text/plain text/css application/json application/javascript;
  gzip_disable "msie6";
  gzip_vary on;

  # Proxy 的共用設定（上傳/串流友善）
  proxy_http_version 1.1;
  proxy_set_header Host              $http_host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_buffering   off;                # 串流/大檔建議關閉
  proxy_request_buffering off;          # 讓大 PUT 直接穿透到上游
  proxy_read_timeout  3600s;
  proxy_send_timeout  3600s;

  include /etc/nginx/conf.d/*.conf;
}
